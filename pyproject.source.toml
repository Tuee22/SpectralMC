[tool.poetry]
name        = "spectralmc"
version     = "0.0.1"
description = "GPU-accelerated library for SDE simulation"
authors     = ["tuee22"]

packages = [
  { include = "spectralmc", from = "src" }
]

# --------------------------------------------------------------------------- #
#                       R U N T I M E   D E P E N D E N C I E S               #
# --------------------------------------------------------------------------- #
[tool.poetry.dependencies]
python = ">=3.12,<3.13"

# ============================================================================
# PYTORCH SOURCE BUILD DEPENDENCIES
# These must be installed BEFORE building PyTorch from source
# ============================================================================
pyyaml            = ">=6.0,<7.0"
typing-extensions = ">=4.0,<5.0"
fastrlock         = ">=0.8,<1.0"
setuptools        = ">=68.0,<69.0"
wheel             = ">=0.41,<1.0"

# core
numpy          = ">=2.0,<3.0"
pandas         = ">=2.0,<3.0"
pandas-stubs   = ">=2.2.3,<3.0"
polars         = ">=1.26,<2.0"
pandera        = { version = ">=0.23.1,<1.0.0", extras = ["mypy","dask","polars"] }
aiohttp        = ">=3.8,<4.0"
aiofiles       = ">=24.1,<25.0"
types-aiofiles = ">=24.1,<25.0"

# distributed compute
dask = { version = ">=2025.3,<2026.0", extras = ["complete"] }
ray  = ">=2.44,<3.0"

# data clients
pulsar-client = ">=3.6,<4.0"
minio         = ">=7.2,<8.0"
protobuf      = ">=6.30,<7.0"
types-protobuf = ">=6.30,<7.0"
boto3         = ">=1.34.70,<2.0.0"
boto3-stubs   = ">=1.34.70,<2.0.0"
aioboto3      = ">=13.0,<14.0"
types-aiobotocore = { version = ">=2.13,<3.0", extras = ["s3"] }

# numerics
scipy            = ">=1.13,<2.0"
scikit-learn     = ">=1.6,<2.0"

# --- PyTorch 2.4.1 compiled from source with CUDA 11.8 (GTX 970 support) --- #
torch        = "2.4.1"
cupy-cuda11x = ">=13.4,<14.0"
safetensors       = ">=0.5.3,<1.0"
numba             = ">=0.61,<1.0"
pystan            = ">=3.10,<4.0"
pymc              = ">=5.22,<6.0"
statsmodels       = ">=0.14.4,<1.0"
QuantLib          = ">=1.37,<2.0"
stable-baselines3 = ">=2.6,<3.0"
gymnasium         = ">=0.29,<1.0"

# Jupyter / viz
plotly      = ">=6.0.1,<7.0"
matplotlib  = ">=3.10.1,<4.0"
seaborn     = ">=0.13.2,<1.0"
tensorboard = ">=2.19.0,<3.0"

# runtime typing / settings
pydantic           = { version = ">=2.9,<3.0", extras = ["mypy"] }
pydantic_settings  = ">=2.7,<3.0"

[tool.poetry.group.dev]
optional = true

[tool.poetry.group.dev.dependencies]
pytest           = ">=8.2,<9.0"
pytest-cov       = ">=5.0,<6.0"
pytest-asyncio   = ">=1.2.0,<2.0"
hypothesis       = ">=6.102,<7.0"
mypy             = ">=1.15,<2.0"
black            = ">=25.1,<26.0"
ruff             = ">=0.8.0"

# --------------------------------------------------------------------------- #
#                            S C R I P T S                                    #
# --------------------------------------------------------------------------- #
[tool.poetry.scripts]
# REQUIRED: All tests must run via poetry per CLAUDE.md
# Usage:
#   poetry run test-all              # Run all tests (CPU + GPU)
#   poetry run test-all <args>       # Forward args to pytest
# Examples:
#   poetry run test-all -v           # Verbose output
#   poetry run test-all -m gpu       # Only GPU tests
#   poetry run test-all tests/test_gbm.py::test_specific  # Specific test
test-all = "spectralmc.test_runner:run_all_tests"

# Code quality (Ruff + Black + MyPy)
# Usage: poetry run check-code
check-code = "tools.check_code:main"

# Type safety variants
typecheck = "tools.check_type_safety:run_mypy_only"
check-types = "tools.check_type_safety:main"
type-check-all = "tools.check_type_safety:run_full_check"

# --------------------------------------------------------------------------- #
#                               B U I L D                                     #
# --------------------------------------------------------------------------- #
[build-system]
requires      = ["poetry-core>=1.1.0"]
build-backend = "poetry.core.masonry.api"


# --------------------------------------------------------------------------- #
#                       T O O L   C O N F I G U R A T I O N                   #
# --------------------------------------------------------------------------- #
[tool.mypy]
mypy_path = "stubs"
python_version = "3.12"
files = ["src/spectralmc", "tests", "tools"]
exclude = ["src/spectralmc/proto/.*_pb2\\.py$"]
plugins = ["pydantic.mypy"]

# Core strictness (equivalent to --strict --disallow-any-explicit)
strict = true
disallow_any_explicit = true

# Additional rigorous checks beyond --strict
disallow_any_unimported = true       # No Any from missing import stubs
disallow_any_decorated = true        # No Any from untyped decorators
disallow_any_generics = true         # No untyped generics
disallow_subclassing_any = true      # Can't inherit from Any
warn_unreachable = true              # Warn about unreachable code
warn_unused_configs = true
warn_redundant_casts = true
warn_unused_ignores = true
warn_no_return = true
warn_return_any = true
extra_checks = true                  # Enable newer experimental checks

# Error reporting and display
show_error_context = true
show_column_numbers = true
show_error_codes = true
pretty = true
color_output = true

# Additional strictness
implicit_reexport = false
no_implicit_reexport = true
disallow_redefinition = true
strict_equality = true
strict_concatenate = true

# Performance and caching
incremental = true
cache_dir = ".mypy_cache"
sqlite_cache = true

# Disable warn_unreachable for tests (runtime assertions valuable even if statically guaranteed)
[[tool.mypy.overrides]]
module = "tests.*"
warn_unreachable = false

[tool.pydantic-mypy]
init_forbid_extra = true
init_typed = true
warn_required_dynamic_aliases = true

[tool.pytest.ini_options]
testpaths = "tests"
addopts   = "-ra -q"
asyncio_mode = "auto"
markers   = ["asyncio: async test"]
filterwarnings = [
    # Hide SWIG-generated DeprecationWarnings raised while importing QuantLib
    # Pattern matches SWIG type definition warnings from <frozen importlib._bootstrap>
    # Module pattern restricts to importlib only (prevents accidentally hiding SpectralMC warnings)
    "ignore:builtin type .* has no __module__ attribute:DeprecationWarning:.*importlib.*",
    # Hide IFFT imaginary component warnings in tests (expected for untrained models)
    "ignore:IFFT imaginary component.*exceeds tolerance:RuntimeWarning",
    # Hide botocore datetime.utcnow() DeprecationWarnings (AWS SDK internal code, waiting for upstream fix)
    # See: https://github.com/boto/botocore/issues/3201
    "ignore::DeprecationWarning:botocore.*",
    "ignore::DeprecationWarning:aiobotocore.*",
    # Suppress Numba grid size warnings in tests (expected for small test datasets)
    # Production code uses large grids (524K blocks) without occupancy issues
    "ignore:Grid size.*will likely result in GPU under-utilization::numba.cuda.dispatcher",
]

# --------------------------------------------------------------------------- #
#                           B L A C K   C O N F I G                           #
# --------------------------------------------------------------------------- #
[tool.black]
line-length = 100
target-version = ['py312']
