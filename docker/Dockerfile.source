# syntax=docker/dockerfile:1.4
# SpectralMC Dockerfile - PyTorch 2.1.2 SOURCE BUILD for GTX 970 (sm_52)
#
# Build Strategy:
# - Early layers: System dependencies (changes rarely, cached aggressively)
# - Middle layers: PyTorch source build (expensive but cached after first build)
# - Late layers: Application code (changes frequently, rebuilds fast)
#
# Build time: 2-4 hours (first build), 15-30 min (code changes with ccache)
#
# CRITICAL: This Dockerfile builds PyTorch from source with explicit sm_52 support
#           Binary wheels NO LONGER SUPPORT GTX 970 (compute capability 5.2)

FROM nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04

ARG DEBIAN_FRONTEND=noninteractive
ENV PATH="/root/.local/bin:/usr/local/bin:$PATH"

# ============================================================================
# LAYER 1: System Dependencies (changes: never)
# ============================================================================

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release \
    curl \
    wget \
    unzip \
    git \
    tmux \
    htop \
    openssh-client \
    jq \
    nano \
    tini \
    bash-completion \
    cmake \
    ninja-build \
    ccache \
    libjpeg-dev \
    libpng-dev \
    && rm -rf /var/lib/apt/lists/*

# ============================================================================
# LAYER 2: Python 3.12 Installation (changes: rarely)
# ============================================================================

RUN add-apt-repository ppa:deadsnakes/ppa -y && \
    apt-get update && apt-get install -y --no-install-recommends \
    python3.12-venv \
    python3.12-dev \
    python3.12-lib2to3 \
    && rm -rf /var/lib/apt/lists/*

RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1 && \
    update-alternatives --set python3 /usr/bin/python3.12 && \
    update-alternatives --install /usr/bin/python python /usr/bin/python3.12 1 && \
    update-alternatives --set python /usr/bin/python3.12

RUN curl -sS https://bootstrap.pypa.io/get-pip.py | python3.12 && \
    python -m pip install --upgrade pip setuptools wheel

# ============================================================================
# LAYER 3: Poetry Installation (changes: rarely)
# ============================================================================

RUN curl -sSL https://install.python-poetry.org | python3.12 - && \
    poetry config virtualenvs.create false

# ============================================================================
# LAYER 4: Install ALL Python Dependencies via Poetry (changes: rarely)
# ============================================================================
# This includes:
# - PyTorch build dependencies (numpy, pyyaml, typing_extensions, fastrlock)
# - SpectralMC runtime dependencies (dask, ray, scipy, etc.)
# - Development dependencies (pytest, mypy, black)
# - CuPy 12.3.0+cu11x
#
# Installed BEFORE PyTorch source build to provide build-time dependencies
# ============================================================================

WORKDIR /spectralmc

# Copy only dependency manifest (not code yet - maximize cache)
COPY pyproject.toml poetry.lock* ./

# Install all dependencies (no groups, all deps in main section)
RUN echo "=== Installing ALL Python dependencies via Poetry ===" && \
    poetry install --no-root --no-interaction && \
    python -c "import numpy; import yaml; import typing_extensions; print('âœ“ PyTorch build deps ready')" && \
    python -c "import cupy; print(f'âœ“ CuPy {cupy.__version__} installed')" && \
    echo "âœ“ All Python dependencies installed"

# ============================================================================
# LAYER 5: ccache Configuration (changes: rarely)
# ============================================================================

ENV CCACHE_DIR=/root/.ccache
ENV CMAKE_CXX_COMPILER_LAUNCHER=ccache
ENV CMAKE_CUDA_COMPILER_LAUNCHER=ccache
RUN ccache --max-size=20G && ccache --zero-stats

# ============================================================================
# LAYER 6: Pre-Build Validation (FAST FAIL - runs in 30 seconds)
# ============================================================================

RUN echo "=== [0/4] Pre-Build Validation ===" && \
    echo "Checking CUDA toolkit..." && \
    nvcc --version || (echo "FATAL: nvcc not found" && exit 1) && \
    echo "Checking Python version..." && \
    python --version | grep "3.12" || (echo "FATAL: Python 3.12 not found" && exit 1) && \
    echo "Checking build tools..." && \
    cmake --version && ninja --version && ccache --version && \
    echo "TARGET: GTX 970 Maxwell (sm_52) with CUDA 11.8" && \
    echo "âœ“ Pre-build validation passed - proceeding with PyTorch source build"

WORKDIR /build

# ============================================================================
# LAYER 7: Clone PyTorch 2.4.1 (changes: when version updates)
# ============================================================================
# PyTorch 2.4.1 chosen for:
# - NumPy 2.0 support (confirmed)
# - CUDA 11.8 support (maintained)
# - Pre-dates Maxwell (sm_52) removal (happened in 2.8)
# - Should support sm_52 when built from source with TORCH_CUDA_ARCH_LIST="5.2"

RUN echo "=== [1/4] Cloning PyTorch 2.4.1 from GitHub ===" && \
    git clone --branch v2.4.1 --recursive --depth 1 \
        https://github.com/pytorch/pytorch.git && \
    echo "âœ“ PyTorch 2.4.1 source cloned"

# ============================================================================
# LAYER 8: Build PyTorch 2.4.1 with sm_52 Support (EXPENSIVE: 2-4 hours)
# ============================================================================
#
# CRITICAL ENVIRONMENT VARIABLES:
# - TORCH_CUDA_ARCH_LIST="5.2": ONLY build sm_52 (saves time, GTX 970 only)
# - USE_CUDA=1: Enable CUDA support
# - USE_CUDNN=1: Enable cuDNN support
# - MAX_JOBS=4: Parallel build jobs (adjust based on RAM: 1-2GB per job)
# - CUDA_HOME: Point to CUDA 11.8 installation
#
# This layer is CACHED after first successful build. Code changes in SpectralMC
# will NOT trigger rebuild of PyTorch.

WORKDIR /build/pytorch

ENV TORCH_CUDA_ARCH_LIST="5.2"
ENV USE_CUDA=1
ENV USE_CUDNN=1
ENV USE_NCCL=0
ENV MAX_JOBS=4
ENV CUDA_HOME=/usr/local/cuda-11.8
ENV PATH=$CUDA_HOME/bin:$PATH
ENV LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH

RUN echo "=== [2/4] Building PyTorch 2.4.1 with sm_52 + NumPy 2.0 support ===" && \
    echo "This will take 2-4 hours. Progress indicators:" && \
    echo "  [1/7000] Building CXX object..." && \
    echo "  [2/7000] Building CUDA object..." && \
    echo "  ..." && \
    echo "  [7000/7000] Linking CXX shared library..." && \
    echo "" && \
    pip install --no-build-isolation -v . 2>&1 | tee /build/pytorch-build.log && \
    echo "âœ“ PyTorch 2.4.1+sm_52+numpy2.0 built successfully"

# ============================================================================
# LAYER 9: Validate PyTorch Build
# ============================================================================

RUN echo "=== [3/4] Validating PyTorch build ===" && \
    python -c "import torch; print(f'PyTorch version: {torch.__version__}')" && \
    python -c "import torch; \
        cuda_ver = torch.version.cuda; \
        print(f'CUDA version: {cuda_ver}'); \
        assert cuda_ver is not None and cuda_ver.startswith('11'), 'Expected CUDA 11.x'" && \
    python -c "import torch; \
        arch_list = str(torch.cuda.get_arch_list()); \
        print(f'Supported architectures: {arch_list}'); \
        assert '5.2' in arch_list or 'sm_52' in arch_list, 'sm_52 not in arch list!'" && \
    echo "BUILD_TYPE=pytorch_source_sm52" > /spectralmc/.build-marker && \
    python -c "import torch; print(f'TORCH_VERSION={torch.__version__}')" >> /spectralmc/.build-marker && \
    python -c "import torch; print(f'TORCH_CUDA={torch.version.cuda}')" >> /spectralmc/.build-marker && \
    python -c "import torch; print(f'TORCH_CUDA_ARCH_LIST={torch.cuda.get_arch_list()}')" >> /spectralmc/.build-marker && \
    date >> /spectralmc/.build-marker && \
    echo "âœ“ PyTorch build validation passed - sm_52 support confirmed"

# ============================================================================
# LAYER 10: Copy Application Source Code (changes: FREQUENTLY)
# THIS IS THE LAST LAYER THAT COPIES CODE - earlier layers are now CACHED
# ============================================================================

COPY ./ /spectralmc/

# ============================================================================
# LAYER 11: Install SpectralMC Package (changes: frequently)
# ============================================================================

RUN echo "=== Installing SpectralMC package ===" && \
    poetry install --no-interaction && \
    echo "âœ“ SpectralMC installed"

# ============================================================================
# LAYER 12: Enforce CLAUDE.md Testing Policies
# ============================================================================

RUN if [ -f /usr/local/bin/pytest ]; then mv /usr/local/bin/pytest /usr/local/bin/pytest.real; fi && \
    echo '#!/bin/sh\necho "âŒ ERROR: Direct pytest forbidden per CLAUDE.md"\necho "âœ… USE: poetry run test-all [pytest-args]"\necho "ðŸ“– Examples:"\necho "  poetry run test-all              # Run all tests"\necho "  poetry run test-all -v           # Verbose output"\necho "  poetry run test-all -m gpu       # GPU tests only"\necho "ðŸ“– Reference: CLAUDE.md testing policies"\nexit 1' > /usr/local/bin/pytest && \
    chmod +x /usr/local/bin/pytest

RUN if [ -f /usr/bin/pytest ]; then mv /usr/bin/pytest /usr/bin/pytest.real; fi && \
    echo '#!/bin/sh\necho "âŒ ERROR: Direct pytest forbidden per CLAUDE.md"\necho "âœ… USE: poetry run test-all [pytest-args]"\necho "ðŸ“– Reference: CLAUDE.md testing policies"\nexit 1' > /usr/bin/pytest && \
    chmod +x /usr/bin/pytest

RUN if [ -f /usr/bin/timeout ]; then mv /usr/bin/timeout /usr/bin/timeout.real; fi && \
    echo '#!/bin/sh\nif echo "$*" | grep -qE "(pytest|test-|test_)"; then\n  echo "âŒ ERROR: Timeout commands with tests forbidden per CLAUDE.md"\n  echo "âœ… USE: poetry run test-all [pytest-args]"\n  echo "ðŸ“– Tests complete when they complete - patience required"\n  exit 1\nfi\nexec /usr/bin/timeout.real "$@"' > /usr/bin/timeout && \
    chmod +x /usr/bin/timeout

# ============================================================================
# LAYER 13: Final Configuration
# ============================================================================

EXPOSE 6006 8888

ENTRYPOINT ["/usr/bin/tini", "--"]

CMD ["jupyter", "lab", "--ip=0.0.0.0", "--port=8888", "--no-browser", "--allow-root", \
     "--NotebookApp.token=", "--NotebookApp.password=", "--notebook-dir=/spectralmc"]
