# syntax=docker/dockerfile:1.4
# SpectralMC Dockerfile.source - Source Build for Legacy GPUs (GTX 970)
#
# This Dockerfile builds PyTorch from source with sm_52 support for Maxwell GPUs.
# For modern GPUs (GTX 1060+), use Dockerfile instead.
#
# Build command:
#   docker compose up --build -d
#
# Build characteristics:
# - PyTorch 2.4.1 compiled from source with sm_52 (GTX 970 Maxwell) support
# - CUDA 11.8 (last version with full Maxwell support)
# - Build time: 2-4 hours (first build), cached afterward
# - GPU support: All NVIDIA GPUs including GTX 970 (compute capability â‰¥ 5.2)
#
# For complete documentation, see documents/engineering/gpu_build.md

FROM nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04
ARG DEBIAN_FRONTEND=noninteractive
ENV PATH="/root/.local/bin:/usr/local/bin:$PATH"
# Set UTF-8 locale for proper Unicode handling in CLI output
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# CuPy JIT compilation settings (for runtime optimization)
ENV CUPY_COMPILE_WITH_PTX=1
ENV CUPY_NVCC_GENERATE_CODE=current

# ============================================================================
# LAYER 1: System Dependencies (changes: never)
# ============================================================================

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release \
    curl \
    wget \
    unzip \
    git \
    tmux \
    htop \
    openssh-client \
    jq \
    nano \
    tini \
    bash-completion \
    libjpeg-dev \
    libpng-dev \
    locales \
    && rm -rf /var/lib/apt/lists/* \
    && locale-gen en_US.UTF-8

# Install protoc from GitHub (need >= 3.19 for protobuf 6.x compatibility)
RUN PROTOC_VERSION=29.5 && \
    wget -q https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-linux-x86_64.zip && \
    unzip -q protoc-${PROTOC_VERSION}-linux-x86_64.zip -d /usr/local && \
    rm protoc-${PROTOC_VERSION}-linux-x86_64.zip && \
    protoc --version

# ============================================================================
# LAYER 2: Python 3.12 Installation (changes: rarely)
# ============================================================================

RUN add-apt-repository ppa:deadsnakes/ppa -y && \
    apt-get update && apt-get install -y --no-install-recommends \
    python3.12-venv \
    python3.12-dev \
    python3.12-lib2to3 \
    && rm -rf /var/lib/apt/lists/*

RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1 && \
    update-alternatives --set python3 /usr/bin/python3.12 && \
    update-alternatives --install /usr/bin/python python /usr/bin/python3.12 1 && \
    update-alternatives --set python /usr/bin/python3.12

# ============================================================================
# LAYER 3: pip and Poetry Installation (single command per doctrine)
# ============================================================================
# Poetry virtual environment config is handled by poetry.toml (virtualenvs.create = false)

RUN curl -sS https://bootstrap.pypa.io/get-pip.py | python3.12 && \
    python -m pip install --upgrade pip setuptools wheel poetry

# ============================================================================
# LAYER 4: Workspace + Build Cache Configuration
# ============================================================================

WORKDIR /spectralmc

ENV CCACHE_DIR=/root/.ccache
ENV CMAKE_CXX_COMPILER_LAUNCHER=ccache
ENV CMAKE_CUDA_COMPILER_LAUNCHER=ccache
ENV PIP_FIND_LINKS=/opt/pytorch-wheel
ENV PIP_CONSTRAINT=/tmp/constraints-source.txt

# Make constraints available before the source build step uses pip
COPY docker/constraints-source.txt /tmp/constraints-source.txt

# ============================================================================
# LAYER 5: BUILD_FROM_SOURCE Inline Build (tools + long compile up front)
# ============================================================================
# All source-build-only installs and the long C/CUDA build live here so they
# don't contaminate the binary path. Artefacts land in /opt and are referenced
# later via PYTHONPATH instead of global site-packages.

RUN /bin/bash -c "set -euo pipefail; \
    echo '=== [0/3] Preparing source build toolchain and cache ==='; \
    apt-get update && apt-get install -y --no-install-recommends cmake ninja-build ccache libopenblas-dev liblapack-dev && rm -rf /var/lib/apt/lists/*; \
    ccache --max-size=20G && ccache --zero-stats; \
    mkdir -p /opt/pytorch-wheel /opt/pytorch /opt/cupy; \
    nvcc --version; python --version | grep '3.12'; \
  "

# Build the sm_52-compatible torch wheel (PyTorch 2.4.1) and stage it under /opt/pytorch-wheel
RUN /bin/bash -c "set -euo pipefail; \
    echo '=== [1/3] Building PyTorch 2.4.1 (sm_52) to /opt ==='; \
    export TORCH_CUDA_ARCH_LIST='5.2' USE_CUDA=1 USE_CUDNN=1 USE_NCCL=0 MAX_JOBS=4 CUDA_HOME=/usr/local/cuda-11.8; \
    export LD_LIBRARY_PATH=/usr/local/cuda-11.8/lib64:\$LD_LIBRARY_PATH BLAS=OpenBLAS USE_LAPACK=1; \
    cd /tmp; git clone --branch v2.4.1 --recursive --depth 1 https://github.com/pytorch/pytorch.git; \
    cd /tmp/pytorch; pip install -r requirements.txt; \
    python setup.py bdist_wheel 2>&1 | tee /tmp/pytorch-build.log; \
    cp dist/*.whl /opt/pytorch-wheel/; \
    rm -rf /tmp/pytorch; \
  "

# ============================================================================
# LAYER 6: Copy Application Source (shared for both build modes)
# ============================================================================

COPY ./ /spectralmc/

# Use the source build pyproject (torch 2.4.1 from /opt/pytorch-wheel)
RUN cp pyproject.source.toml pyproject.toml

# ============================================================================
# LAYER 7: Install SpectralMC (identical Poetry command for both build modes)
# ============================================================================

RUN echo "=== Installing SpectralMC via Poetry (incl. dev tools for check-code) ===" && \
    poetry source show && \
    poetry config --list && \
    poetry install -vvv --no-interaction --with dev

RUN /bin/bash -c "set -euo pipefail; \
    echo '=== [2/3] Swapping Poetry torch/cupy for source-built artefacts ==='; \
    python -m pip uninstall -y torch cupy-cuda11x fastrlock || true; \
    PIP_CONSTRAINT= python -m pip install --no-deps --no-warn-script-location --target /opt/pytorch /opt/pytorch-wheel/*.whl; \
    PIP_CONSTRAINT= python -m pip install --no-deps --no-warn-script-location --target /opt/cupy 'cupy-cuda11x>=13.4,<14.0'; \
    PIP_CONSTRAINT= python -m pip install --no-deps --no-warn-script-location --target /opt/cupy 'fastrlock>=0.8,<1.0'; \
    python -c \"import site; from pathlib import Path; pth = Path(site.getsitepackages()[0]) / 'spectralmc-opt.pth'; pth.write_text('/opt/pytorch\\n/opt/cupy\\n'); print(f'âœ“ Wrote {pth} to expose /opt artefacts')\"; \
    PYTHONPATH=/opt/pytorch:/opt/cupy:${PYTHONPATH:-} python -c \"import torch, cupy; print(f'âœ“ Staged torch {torch.__version__} (cuda={torch.version.cuda}) from /opt/pytorch'); print(f'âœ“ Staged cupy {cupy.__version__} from /opt/cupy')\" || { cat /tmp/pytorch-build.log; exit 1; }; \
  "

# ============================================================================
# LAYER 7.5: Generate Protobuf Code into /opt/spectralmc_proto
# ============================================================================

RUN echo "=== Generating protobuf modules ===" && \
    mkdir -p /opt/spectralmc_proto && \
    protoc \
        --python_out=/opt/spectralmc_proto \
        --proto_path=/spectralmc/src/spectralmc/proto \
        /spectralmc/src/spectralmc/proto/*.proto && \
    echo '"""Generated protobuf modules for SpectralMC."""' > /opt/spectralmc_proto/__init__.py && \
    ls -la /opt/spectralmc_proto/

# Update .pth file to include /opt and /opt/spectralmc_proto (for cross-imports)
RUN python -c "import site; from pathlib import Path; pth = Path(site.getsitepackages()[0]) / 'spectralmc-opt.pth'; pth.write_text('/opt/pytorch\n/opt/cupy\n/opt/spectralmc_proto\n/opt\n'); print(f'âœ“ Updated {pth}')"

# Verify
RUN PYTHONPATH=/opt/pytorch:/opt/cupy:/opt:${PYTHONPATH:-} python -c "import spectralmc_proto.common_pb2; print('âœ“ Loaded protobuf')" || exit 1

# ============================================================================
# LAYER 8: Enforce CLAUDE.md Testing Policies
# ============================================================================

RUN if [ -f /usr/local/bin/pytest ]; then mv /usr/local/bin/pytest /usr/local/bin/pytest.real; fi && \
    echo '#!/bin/sh\necho "âŒ ERROR: Direct pytest forbidden per CLAUDE.md"\necho "âœ… USE: poetry run test-all [pytest-args]"\necho "ðŸ“– Examples:"\necho "  poetry run test-all              # Run all tests"\necho "  poetry run test-all -v           # Verbose output"\necho "  poetry run test-all -m gpu       # GPU tests only"\necho "ðŸ“– Reference: CLAUDE.md testing policies"\nexit 1' > /usr/local/bin/pytest && \
    chmod +x /usr/local/bin/pytest

RUN if [ -f /usr/bin/pytest ]; then mv /usr/bin/pytest /usr/bin/pytest.real; fi && \
    echo '#!/bin/sh\necho "âŒ ERROR: Direct pytest forbidden per CLAUDE.md"\necho "âœ… USE: poetry run test-all [pytest-args]"\necho "ðŸ“– Reference: CLAUDE.md testing policies"\nexit 1' > /usr/bin/pytest && \
    chmod +x /usr/bin/pytest

RUN if [ -f /usr/bin/timeout ]; then mv /usr/bin/timeout /usr/bin/timeout.real; fi && \
    echo '#!/bin/sh\nif echo "$*" | grep -qE "(pytest|test-|test_)"; then\n  echo "âŒ ERROR: Timeout commands with tests forbidden per CLAUDE.md"\n  echo "âœ… USE: poetry run test-all [pytest-args]"\n  echo "ðŸ“– Tests complete when they complete - patience required"\n  exit 1\nfi\nexec /usr/bin/timeout.real "$@"' > /usr/bin/timeout && \
    chmod +x /usr/bin/timeout

# ============================================================================
# LAYER 9: Final Configurationand 
# ============================================================================

EXPOSE 6006

ENTRYPOINT ["/usr/bin/tini", "--"]

CMD ["sleep", "infinity"]
