# syntax=docker/dockerfile:1.4
# SpectralMC Dockerfile - Dual-Mode Build Strategy
#
# Binary build (default - fast):
#   docker compose up --build -d
#   - PyTorch 2.7.1 binary wheel (CUDA 11.8)
#   - Build time: 10-15 minutes
#   - GPU support: GTX 1060+, RTX series, Tesla P100+ (compute capability â‰¥ 6.0)
#
# Source build (GTX 970 support):
#   BUILD_FROM_SOURCE=true docker compose up --build -d
#   - PyTorch 2.4.1 compiled from source with sm_52 (GTX 970 Maxwell) support
#   - Build time: 2-4 hours (first build), cached afterward
#   - GPU support: All NVIDIA GPUs including GTX 970 (compute capability â‰¥ 5.2)
#
# Layer Strategy:
# - Early layers: System dependencies (changes rarely, cached aggressively)
# - Middle layers: PyTorch installation (conditional: binary or source)
# - Late layers: Application code (changes frequently, rebuilds fast)

FROM nvidia/cuda:11.8.0-cudnn8-devel-ubuntu22.04
ARG BUILD_FROM_SOURCE=false
ARG DEBIAN_FRONTEND=noninteractive
ENV PATH="/root/.local/bin:/usr/local/bin:$PATH"
# Set UTF-8 locale for proper Unicode handling in CLI output
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# CuPy JIT compilation settings (for runtime optimization)
ENV CUPY_COMPILE_WITH_PTX=1
ENV CUPY_NVCC_GENERATE_CODE=current

# ============================================================================
# LAYER 1: System Dependencies (changes: never)
# ============================================================================

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release \
    curl \
    wget \
    unzip \
    git \
    tmux \
    htop \
    openssh-client \
    jq \
    nano \
    tini \
    bash-completion \
    libjpeg-dev \
    libpng-dev \
    locales \
    && rm -rf /var/lib/apt/lists/* \
    && locale-gen en_US.UTF-8

# ============================================================================
# LAYER 1.5: Build Tools for Source Builds ONLY (changes: never)
# ============================================================================

RUN if [ "$BUILD_FROM_SOURCE" = "true" ]; then \
        apt-get update && apt-get install -y --no-install-recommends \
        cmake \
        ninja-build \
        ccache \
        libopenblas-dev \
        liblapack-dev \
        && rm -rf /var/lib/apt/lists/*; \
    fi

# ============================================================================
# LAYER 2: Python 3.12 Installation (changes: rarely)
# ============================================================================

RUN add-apt-repository ppa:deadsnakes/ppa -y && \
    apt-get update && apt-get install -y --no-install-recommends \
    python3.12-venv \
    python3.12-dev \
    python3.12-lib2to3 \
    && rm -rf /var/lib/apt/lists/*

RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1 && \
    update-alternatives --set python3 /usr/bin/python3.12 && \
    update-alternatives --install /usr/bin/python python /usr/bin/python3.12 1 && \
    update-alternatives --set python /usr/bin/python3.12

RUN curl -sS https://bootstrap.pypa.io/get-pip.py | python3.12 && \
    python -m pip install --upgrade pip setuptools wheel

# ============================================================================
# LAYER 3: Poetry Installation (changes: rarely)
# ============================================================================

RUN python -m pip install --upgrade pip setuptools wheel poetry && \
    poetry config virtualenvs.create false

# ============================================================================
# LAYER 4: Python Build Dependencies (changes: rarely)
# ============================================================================

RUN pip install --no-cache-dir setuptools wheel pyyaml typing_extensions numpy fastrlock

# ============================================================================
# LAYER 5: Early Validation (FAST FAIL - runs in 30 seconds)
# ============================================================================

RUN if [ "$BUILD_FROM_SOURCE" = "true" ]; then \
        echo "=== [0/3] Pre-Build Validation ===" && \
        echo "Build mode: PyTorch SOURCE build (sm_52 support for GTX 970)" && \
        echo "Checking CUDA toolkit..." && \
        nvcc --version || (echo "FATAL: nvcc not found" && exit 1) && \
        echo "Checking Python version..." && \
        python --version | grep "3.12" || (echo "FATAL: Python 3.12 not found" && exit 1) && \
        echo "TARGET: All NVIDIA GPUs including GTX 970 Maxwell (sm_52) with CUDA 11.8" && \
        echo "âœ“ Pre-build validation passed"; \
    else \
        echo "=== [0/3] Pre-Build Validation ===" && \
        echo "Build mode: PyTorch BINARY build (fast)" && \
        echo "Checking Python version..." && \
        python --version | grep "3.12" || (echo "FATAL: Python 3.12 not found" && exit 1) && \
        echo "TARGET: Modern NVIDIA GPUs (GTX 1060+, RTX series) with CUDA 11.8" && \
        echo "âœ“ Pre-build validation passed"; \
    fi

# ============================================================================
# LAYER 6: ccache Configuration (for source builds only)
# ============================================================================

RUN if [ "$BUILD_FROM_SOURCE" = "true" ]; then \
        export CCACHE_DIR=/root/.ccache && \
        export CMAKE_CXX_COMPILER_LAUNCHER=ccache && \
        export CMAKE_CUDA_COMPILER_LAUNCHER=ccache && \
        ccache --max-size=20G && ccache --zero-stats; \
    fi

WORKDIR /spectralmc

# ============================================================================
# LAYER 7: Copy Dependency Manifests ONLY (changes: occasionally)
# ============================================================================

COPY pyproject.toml ./

# ============================================================================
# LAYER 8: Install SpectralMC Dependencies FIRST (before PyTorch source build)
# ============================================================================
# Poetry install may pull in torch as a transitive dependency.
# We run it first, then build PyTorch from source to override.

RUN echo "=== [1/3] Installing SpectralMC dependencies (Poetry) ===" && \
    poetry install --no-interaction --no-root && \
    echo "âœ“ Dependencies installed"

# ============================================================================
# LAYER 9: Install PyTorch - Binary OR Source Build (AFTER poetry)
# ============================================================================

RUN if [ "$BUILD_FROM_SOURCE" = "true" ]; then \
        echo "=== [2/3] Building PyTorch 2.4.1 from source (sm_52 + NumPy 2.0) ===" && \
        echo "This will take 2-4 hours. Patience required." && \
        echo "Note: This overrides any torch installed by poetry" && \
        export TORCH_CUDA_ARCH_LIST="5.2" && \
        export USE_CUDA=1 && \
        export USE_CUDNN=1 && \
        export USE_NCCL=0 && \
        export MAX_JOBS=4 && \
        export CUDA_HOME=/usr/local/cuda-11.8 && \
        export LD_LIBRARY_PATH=/usr/local/cuda-11.8/lib64:$LD_LIBRARY_PATH && \
        export BLAS=OpenBLAS && \
        export USE_LAPACK=1 && \
        cd /tmp && \
        git clone --branch v2.4.1 --recursive --depth 1 https://github.com/pytorch/pytorch.git && \
        cd /tmp/pytorch && \
        python setup.py bdist_wheel 2>&1 | tee /tmp/pytorch-build.log && \
        mkdir -p /opt/pytorch-wheel && \
        cp dist/*.whl /opt/pytorch-wheel/ && \
        pip install --force-reinstall /opt/pytorch-wheel/*.whl && \
        cd /spectralmc && \
        rm -rf /tmp/pytorch && \
        python -c "import torch; print(f'âœ“ PyTorch {torch.__version__} built from source')" && \
        python -c "import torch; print(f'  CUDA version: {torch.version.cuda}')" && \
        echo "BUILD_TYPE=pytorch_source_sm52" > /spectralmc/.build-marker && \
        echo "NOTE: sm_52 validation requires GPU access - will be tested at runtime"; \
    else \
        echo "=== [2/3] Using PyTorch binary from Poetry (fast) ===" && \
        python -c "import torch; print(f'âœ“ PyTorch {torch.__version__} installed via Poetry')" && \
        python -c "import torch; print(f'  CUDA version: {torch.version.cuda}')" && \
        echo "BUILD_TYPE=pytorch_binary_cu118" > /spectralmc/.build-marker; \
    fi

# ============================================================================
# LAYER 10: Verify CuPy Installation (NumPy 2.0 compatible)
# ============================================================================

RUN echo "=== [3/3] Verifying CuPy installation ===" && \
    python -c "import cupy; print(f'âœ“ CuPy {cupy.__version__} installed via Poetry')"

# ============================================================================
# LAYER 11: Validate CUDA Build
# ============================================================================

RUN echo "=== Validating CUDA build ===" && \
    python -c "import torch; cuda_ver = torch.version.cuda; print(f'PyTorch CUDA version: {cuda_ver}'); assert cuda_ver is not None and cuda_ver.startswith('11'), 'Expected CUDA 11.x'" && \
    python -c "import cupy; print(f'CuPy version: {cupy.__version__}')" && \
    python -c "import torch; print(f'TORCH_VERSION={torch.__version__}')" >> /spectralmc/.build-marker && \
    python -c "import torch; print(f'TORCH_CUDA={torch.version.cuda}')" >> /spectralmc/.build-marker && \
    date >> /spectralmc/.build-marker && \
    echo "âœ“ Build validation passed"

# ============================================================================
# LAYER 12: Copy Application Source Code (changes: FREQUENTLY)
# ============================================================================

COPY ./ /spectralmc/

# ============================================================================
# LAYER 13: Install SpectralMC Package (changes: frequently)
# ============================================================================

RUN echo "=== Installing SpectralMC package ===" && \
    poetry install --no-interaction && \
    if [ -f /spectralmc/.build-marker ] && grep -q "pytorch_source_sm52" /spectralmc/.build-marker; then \
        echo "=== Restoring source-built PyTorch (poetry overwrote it) ===" && \
        pip install --force-reinstall --no-deps /opt/pytorch-wheel/*.whl && \
        python -c "import torch; print(f'Restored PyTorch {torch.__version__} CUDA {torch.version.cuda}')"; \
    fi && \
    echo "âœ“ SpectralMC installed"

# ============================================================================
# LAYER 14: Enforce CLAUDE.md Testing Policies
# ============================================================================

RUN if [ -f /usr/local/bin/pytest ]; then mv /usr/local/bin/pytest /usr/local/bin/pytest.real; fi && \
    echo '#!/bin/sh\necho "âŒ ERROR: Direct pytest forbidden per CLAUDE.md"\necho "âœ… USE: poetry run test-all [pytest-args]"\necho "ðŸ“– Examples:"\necho "  poetry run test-all              # Run all tests"\necho "  poetry run test-all -v           # Verbose output"\necho "  poetry run test-all -m gpu       # GPU tests only"\necho "ðŸ“– Reference: CLAUDE.md testing policies"\nexit 1' > /usr/local/bin/pytest && \
    chmod +x /usr/local/bin/pytest

RUN if [ -f /usr/bin/pytest ]; then mv /usr/bin/pytest /usr/bin/pytest.real; fi && \
    echo '#!/bin/sh\necho "âŒ ERROR: Direct pytest forbidden per CLAUDE.md"\necho "âœ… USE: poetry run test-all [pytest-args]"\necho "ðŸ“– Reference: CLAUDE.md testing policies"\nexit 1' > /usr/bin/pytest && \
    chmod +x /usr/bin/pytest

RUN if [ -f /usr/bin/timeout ]; then mv /usr/bin/timeout /usr/bin/timeout.real; fi && \
    echo '#!/bin/sh\nif echo "$*" | grep -qE "(pytest|test-|test_)"; then\n  echo "âŒ ERROR: Timeout commands with tests forbidden per CLAUDE.md"\n  echo "âœ… USE: poetry run test-all [pytest-args]"\n  echo "ðŸ“– Tests complete when they complete - patience required"\n  exit 1\nfi\nexec /usr/bin/timeout.real "$@"' > /usr/bin/timeout && \
    chmod +x /usr/bin/timeout

# ============================================================================
# LAYER 15: Final Configuration
# ============================================================================

EXPOSE 6006 8888

ENTRYPOINT ["/usr/bin/tini", "--"]

CMD ["jupyter", "lab", "--ip=0.0.0.0", "--port=8888", "--no-browser", "--allow-root", \
     "--NotebookApp.token=", "--NotebookApp.password=", "--notebook-dir=/spectralmc"]
